import 'dart:convert';
import 'package:dio/dio.dart';
import 'package:food_app/core/api_client.dart';

class OrderRepository {
  /// âœ… Ø¥Ù†Ø´Ø§Ø¡ Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯
Future<Map<String, dynamic>> createOrder(Map<String, dynamic> orderData) async {
  try {
    await ApiClient.setAuthHeader();
    final res = await ApiClient.dio.post(
      '/create-order',
      data: orderData,
    );

    print('âœ… Order created successfully: ${res.data}');
    
    // Return the complete response from Laravel
    // Laravel returns: {'message': '...', 'order': {...}}
    return {
      'success': true,
      'data': res.data, // This contains both 'message' and 'order'
      'message': res.data['message'] ?? 'ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­ âœ…'
    };
  } on DioException catch (e) {
    return _handleDioError(e);
  } catch (e) {
    return {
      'success': false, 
      'message': 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø·Ù„Ø¨: $e'
    };
  }
}

  /// âœ… Ø¬Ù„Ø¨ Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
  Future<Map<String, dynamic>> getUserOrders() async {
    try {
      await ApiClient.setAuthHeader();
      final res = await ApiClient.dio.get('/user-orders');
      
      return {
        'success': true,
        'data': res.data,
      };
    } on DioException catch (e) {
      return _handleDioError(e);
    } catch (e) {
      return {
        'success': false,
        'message': 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¬Ù„Ø¨ Ø§Ù„Ø·Ù„Ø¨Ø§Øª: $e'
      };
    }
  }

  /// âœ… Ø¬Ù„Ø¨ ØªÙØ§ØµÙŠÙ„ Ø·Ù„Ø¨ Ù…Ø­Ø¯Ø¯
  Future<Map<String, dynamic>> getOrderDetails(String orderId) async {
    try {
      await ApiClient.setAuthHeader();
      final res = await ApiClient.dio.get('/orders/$orderId');
      
      return {
        'success': true,
        'data': res.data,
      };
    } on DioException catch (e) {
      return _handleDioError(e);
    } catch (e) {
      return {
        'success': false,
        'message': 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¬Ù„Ø¨ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨: $e'
      };
    }
  }

  /// ğŸ§© Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© Ø£Ø®Ø·Ø§Ø¡ Dio
  Map<String, dynamic> _handleDioError(DioException e) {
    if (e.response != null) {
      final data = e.response?.data;
      return {
        'success': false,
        'message': data['message'] ?? 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±',
        'errors': data['errors'] ?? {},
        'statusCode': e.response?.statusCode,
      };
    } else if (e.type == DioExceptionType.connectionTimeout ||
        e.type == DioExceptionType.receiveTimeout) {
      return {'success': false, 'message': 'â± Ø§Ù†ØªÙ‡Ù‰ ÙˆÙ‚Øª Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±'};
    } else if (e.type == DioExceptionType.connectionError) {
      return {'success': false, 'message': 'âš ï¸ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø´Ø¨ÙƒØ©'};
    } else {
      return {'success': false, 'message': 'Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹: ${e.message}'};
    }
  }
}